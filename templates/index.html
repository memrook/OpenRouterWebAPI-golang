<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Deepseek Chat</title>
    <script src="https://unpkg.com/htmx.org@1.9.10"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <link rel="icon" type="image/x-icon" href="/templates/deepseek.svg">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/atom-one-dark.min.css">
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .chat-container {
            background-color: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .header-container {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        .reset-button {
            padding: 8px 15px;
            background-color: #dc3545;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
        }
        .reset-button:hover {
            background-color: #c82333;
        }
        .action-buttons {
            display: flex;
            gap: 10px;
        }
        .stream-toggle {
            padding: 8px 15px;
            background-color: #6c757d;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
        }
        .stream-toggle.active {
            background-color: #28a745;
        }
        .stream-toggle:hover {
            opacity: 0.9;
        }
        .input-container {
            display: flex;
            gap: 10px;
            margin-top: 20px;
            position: relative;
        }
        textarea {
            flex-grow: 1;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            resize: vertical;
            min-height: 50px;
            font-size: 16px;
            font-family: monospace;
        }
        button {
            padding: 10px 20px;
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            min-width: 120px;
        }
        button:hover {
            background-color: #0056b3;
        }
        .response {
            margin-top: 20px;
            padding: 15px;
            background-color: #f8f9fa;
            border-radius: 5px;
            position: relative;
            transition: all 0.3s ease;
            font-size: 16px;
            line-height: 1.5;
        }
        .response.fade-in {
            animation: fadeIn 0.5s ease-in;
        }
        .response .math {
            margin: 10px 0;
            padding: 10px;
            background-color: #fff;
            border-radius: 5px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            overflow-x: auto;
        }
        /* Стили для истории сообщений */
        .conversation-history {
            margin-bottom: 20px;
            max-height: 500px;
            overflow-y: auto;
            border: 1px solid #eee;
            border-radius: 5px;
            padding: 10px;
        }
        .message {
            margin-bottom: 15px;
            padding: 10px;
            border-radius: 5px;
        }
        .message-user {
            background-color: #e9f5ff;
            margin-left: 20%;
            border-left: 3px solid #007bff;
        }
        .message-assistant {
            background-color: #f8f9fa;
            margin-right: 20%;
            border-left: 3px solid #28a745;
        }
        .message-role {
            font-size: 12px;
            color: #666;
            margin-bottom: 5px;
            font-weight: bold;
        }
        .message-content {
            white-space: pre-wrap;
        }
        /* Markdown стили */
        .response h1, .response h2, .response h3, .response h4, .response h5, .response h6,
        .message-content h1, .message-content h2, .message-content h3, .message-content h4, .message-content h5, .message-content h6 {
            margin-top: 1.5em;
            margin-bottom: 0.5em;
            color: #2c3e50;
        }
        .response p, .message-content p {
            margin: 1em 0;
            line-height: 1.6;
        }
        .response ul, .response ol, .message-content ul, .message-content ol {
            margin: 1em 0;
            padding-left: 2em;
        }
        .response blockquote, .message-content blockquote {
            margin: 1em 0;
            padding-left: 1em;
            border-left: 4px solid #007bff;
            color: #666;
        }
        .response a, .message-content a {
            color: #007bff;
            text-decoration: none;
        }
        .response a:hover, .message-content a:hover {
            text-decoration: underline;
        }
        .response table, .message-content table {
            border-collapse: collapse;
            margin: 1em 0;
            width: 100%;
        }
        .response th, .response td, .message-content th, .message-content td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }
        .response th, .message-content th {
            background-color: #f8f9fa;
        }
        .response img, .message-content img {
            max-width: 100%;
            height: auto;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .loading-container {
            display: none;
            position: absolute;
            right: 0;
            top: 50%;
            transform: translateY(-50%);
            background-color: #007bff;
            color: white;
            padding: 10px 15px;
            border-radius: 5px;
            animation: pulse 1.5s infinite;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }
        .htmx-request .loading-container {
            display: flex;
        }
        .htmx-request .submit-btn {
            display: none;
        }
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.7; }
            100% { opacity: 1; }
        }
        .loading-dots::after {
            content: '...';
            animation: dots 1.5s steps(4, end) infinite;
            display: inline-block;
            width: 1.5em;
        }
        @keyframes dots {
            0%, 20% { content: '.'; }
            40% { content: '..'; }
            60% { content: '...'; }
            80%, 100% { content: ''; }
        }
        .error {
            color: #dc3545;
            background-color: #f8d7da;
            border: 1px solid #f5c6cb;
            padding: 10px;
            border-radius: 5px;
            margin-top: 10px;
            animation: shake 0.5s ease-in-out;
        }
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            10%, 30%, 50%, 70%, 90% { transform: translateX(-5px); }
            20%, 40%, 60%, 80% { transform: translateX(5px); }
        }
        .status-indicator {
            display: none;
            padding: 8px 12px;
            border-radius: 4px;
            margin-top: 10px;
            font-size: 0.9em;
        }
        .status-success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .status-error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        /* Стили для LaTeX блоков */
        .latex-block {
            margin: 15px 0;
            padding: 15px;
            background-color: #fff;
            border-radius: 5px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            font-size: 1.1em;
        }
        /* Стили для inline LaTeX */
        .latex-inline {
            padding: 0 5px;
        }
        /* Стили для блоков кода */
        .code-block, pre {
            margin: 15px 0;
            padding: 15px;
            background-color: #282c34;
            border-radius: 5px;
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 14px;
            line-height: 1.4;
            overflow-x: auto;
        }
        .code-block code, pre code {
            padding: 0;
            background: none;
            white-space: pre;
            color: #f8f8f2;
        }
        /* Стили для inline кода */
        code:not(.code-block code):not(pre code) {
            background-color: #f3f4f5;
            padding: 2px 4px;
            border-radius: 3px;
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 0.9em;
            color: #e83e8c;
        }
        /* Добавляем стили для индикатора загрузки */
        .loading-spinner {
            display: inline-block;
            width: 18px;
            height: 18px;
            border: 3px solid rgba(255,255,255,0.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s ease-in-out infinite;
            margin-left: 5px;
            vertical-align: middle;
            flex-shrink: 0; /* Предотвращает сжатие */
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Стиль для подсказки о горячих клавишах */
        .hotkey-hint {
            position: absolute;
            bottom: -20px;
            right: 0;
            font-size: 12px;
            color: #666;
        }

        /* Стиль для отключенной кнопки во время загрузки */
        .submit-btn:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }

        /* Индикатор времени ожидания */
        .response-time {
            position: absolute;
            top: 10px;
            right: 10px;
            font-size: 12px;
            color: #666;
        }
        
        .context-info {
            font-size: 12px;
            color: #666;
            margin-top: 5px;
            text-align: right;
        }
        
        /* Стиль для кнопки отмены */
        .cancel-btn {
            background-color: #dc3545;
            display: none;
        }
        .cancel-btn:hover {
            background-color: #c82333;
        }
        .streaming .cancel-btn {
            display: inline-block;
        }
        .streaming .submit-btn {
            display: none;
        }
        
        /* Курсор ввода для симуляции набора текста */
        .cursor-typing {
            display: inline-block;
            width: 5px;
            height: 17px;
            background-color: #333;
            margin-left: 2px;
            animation: blink 1s infinite;
            vertical-align: middle;
        }
        @keyframes blink {
            0%, 100% { opacity: 1; }
            50% { opacity: 0; }
        }
    </style>
</head>
<body>
    <div class="chat-container">
        <div class="header-container">
            <h1>Deepseek Chat</h1>
            <div class="action-buttons">
                <button id="stream-toggle" class="stream-toggle active" title="Режим потоковой загрузки ответов">Стриминг: вкл</button>
                <button class="reset-button" 
                        hx-post="/reset" 
                        hx-confirm="Вы уверены, что хотите сбросить всю историю беседы?"
                        hx-target="#conversation-history"
                        hx-swap="innerHTML">Сбросить историю</button>
            </div>
        </div>
        
        <!-- История сообщений -->
        <div id="conversation-history" class="conversation-history">
            {{if .Messages}}
                {{range .Messages}}
                    <div class="message {{if eq .Role "user"}}message-user{{else}}message-assistant{{end}}">
                        <div class="message-role">{{if eq .Role "user"}}Вы{{else}}Deepseek{{end}}</div>
                        <div class="message-content">{{.Content}}</div>
                    </div>
                {{end}}
            {{else}}
                <div class="context-info">История беседы пуста</div>
            {{end}}
        </div>
        
        <form id="chat-form">
            <div class="input-container">
                <textarea name="message" 
                         id="message-input"
                         placeholder="Введите ваше сообщение... Поддерживается Markdown, LaTeX (например, $x^2 + y^2 = r^2$) и блоки кода (в ```)" 
                         required></textarea>
                <button type="submit" class="submit-btn" id="submit-btn">Отправить</button>
                <button type="button" class="cancel-btn" id="cancel-btn">Отмена</button>
                <div class="loading-container">
                    <span>Генерирую</span>
                    <div class="loading-spinner"></div>
                </div>
                <div class="hotkey-hint">Cmd+Enter / Ctrl+Enter для отправки</div>
            </div>
        </form>
        <div id="response" class="response"></div>
        <div id="status" class="status-indicator"></div>
        <div class="context-info">
            <span id="context-size">Сообщений в истории: {{len .Messages}}</span>
        </div>
    </div>

    <script>
        // Настройка Marked
        marked.setOptions({
            highlight: function(code, lang) {
                if (lang && hljs.getLanguage(lang)) {
                    return hljs.highlight(code, { language: lang }).value;
                }
                return hljs.highlightAuto(code).value;
            },
            breaks: true,
            gfm: true,
            headerIds: true,
            mangle: false
        });

        let startTime = null;
        let timerInterval = null;
        let streamController = null; // Для отмены потока
        let isStreaming = true; // По умолчанию стриминг включен
        
        // Переключение режима стриминга
        document.getElementById('stream-toggle').addEventListener('click', function() {
            isStreaming = !isStreaming;
            this.classList.toggle('active');
            this.textContent = isStreaming ? 'Стриминг: вкл' : 'Стриминг: выкл';
        });

        // Форматируем содержимое сообщений при загрузке страницы
        document.addEventListener('DOMContentLoaded', function() {
            // Форматируем все сообщения в истории
            document.querySelectorAll('.message-content').forEach(function(element) {
                const rawText = element.textContent;
                element.innerHTML = marked.parse(rawText);
                
                // Подсвечиваем код
                element.querySelectorAll('pre code').forEach((block) => {
                    hljs.highlightElement(block);
                });
            });
            
            // Подсвечиваем математические формулы
            if (window.MathJax) {
                MathJax.typesetPromise(document.querySelectorAll('.message-content'))
                    .catch((err) => console.log('MathJax error:', err));
            }
            
            // Прокручиваем к последнему сообщению
            const historyDiv = document.querySelector('.conversation-history');
            if (historyDiv) {
                historyDiv.scrollTop = historyDiv.scrollHeight;
            }
        });

        function updateResponseTime() {
            if (startTime) {
                const elapsed = Math.floor((Date.now() - startTime) / 1000);
                const minutes = Math.floor(elapsed / 60);
                const seconds = elapsed % 60;
                const timeStr = minutes > 0 ? 
                    `${minutes}м ${seconds}с` : 
                    `${seconds}с`;
                
                const responseDiv = document.getElementById('response');
                let timeDiv = responseDiv.querySelector('.response-time');
                if (!timeDiv) {
                    timeDiv = document.createElement('div');
                    timeDiv.className = 'response-time';
                    responseDiv.appendChild(timeDiv);
                }
                timeDiv.textContent = `Время ответа: ${timeStr}`;
            }
        }

        // Обработка отмены потокового запроса
        document.getElementById('cancel-btn').addEventListener('click', function() {
            if (streamController) {
                streamController.abort();
                streamController = null;
                document.body.classList.remove('streaming');
                
                const submitBtn = document.getElementById('submit-btn');
                const messageInput = document.getElementById('message-input');
                
                // Включаем элементы формы
                submitBtn.disabled = false;
                messageInput.disabled = false;
                
                // Останавливаем таймер
                if (timerInterval) {
                    clearInterval(timerInterval);
                    timerInterval = null;
                }
                
                // Показываем статус
                const statusDiv = document.getElementById('status');
                statusDiv.className = 'status-indicator status-error';
                statusDiv.textContent = 'Запрос отменен';
                statusDiv.style.display = 'block';
                
                // Убираем курсор набора текста
                const cursor = document.querySelector('.cursor-typing');
                if (cursor) cursor.remove();
            }
        });

        // Обработка горячих клавиш
        document.getElementById('message-input').addEventListener('keydown', function(e) {
            if ((e.metaKey || e.ctrlKey) && e.key === 'Enter') {
                e.preventDefault();
                if (!document.getElementById('submit-btn').disabled) {
                    document.getElementById('chat-form').dispatchEvent(new Event('submit'));
                }
            }
        });

        // Обработка отправки формы
        document.getElementById('chat-form').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const submitBtn = document.getElementById('submit-btn');
            const messageInput = document.getElementById('message-input');
            const statusDiv = document.getElementById('status');
            const responseDiv = document.getElementById('response');
            
            // Проверяем, не пустое ли сообщение
            const message = messageInput.value.trim();
            if (!message) return;
            
            // Отключаем элементы формы
            submitBtn.disabled = true;
            messageInput.disabled = true;
            
            // Очищаем предыдущий ответ и статус
            responseDiv.innerHTML = '';
            responseDiv.classList.remove('fade-in');
            statusDiv.style.display = 'none';
            
            // Запускаем таймер
            startTime = Date.now();
            if (timerInterval) clearInterval(timerInterval);
            timerInterval = setInterval(updateResponseTime, 1000);
            
            if (isStreaming) {
                // Используем потоковый режим
                handleStreamingRequest(message);
            } else {
                // Используем обычный режим
                handleRegularRequest(message);
            }
        });
        
        // Обработка потокового запроса
        function handleStreamingRequest(message) {
            const responseDiv = document.getElementById('response');
            const statusDiv = document.getElementById('status');
            
            // Создаем курсор набора текста
            responseDiv.innerHTML = '<span class="cursor-typing"></span>';
            
            // Отмечаем, что идет стриминг
            document.body.classList.add('streaming');
            
            // Подготавливаем контроллер для возможности отмены
            streamController = new AbortController();
            
            // Отправляем запрос в потоковом режиме
            fetch('/stream', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                },
                body: `message=${encodeURIComponent(message)}`,
                signal: streamController.signal
            }).then(response => {
                if (!response.ok) {
                    throw new Error(`Ошибка сервера: ${response.status}`);
                }
                
                // Очищаем перед началом получения частей ответа
                responseDiv.innerHTML = '';
                
                const reader = response.body.getReader();
                const decoder = new TextDecoder();
                
                // Функция для чтения потока
                function readStream() {
                    return reader.read().then(({ value, done }) => {
                        if (done) {
                            // Обработка завершения потока
                            completeStreaming();
                            return;
                        }
                        
                        const chunk = decoder.decode(value, { stream: true });
                        const lines = chunk.split('\n\n');
                        
                        lines.forEach(line => {
                            if (line.startsWith('data: ')) {
                                const data = line.substring(6);
                                
                                // Проверяем, не завершающее ли это сообщение
                                if (data === '[DONE]') {
                                    completeStreaming();
                                    return;
                                }
                                
                                // Добавляем текст к ответу
                                const existingText = responseDiv.innerHTML;
                                const newText = existingText + data;
                                responseDiv.innerHTML = newText;
                            }
                        });
                        
                        // Продолжаем чтение потока
                        return readStream();
                    });
                }
                
                // Начинаем чтение потока
                return readStream();
            })
            .catch(error => {
                if (error.name === 'AbortError') {
                    // Запрос был отменен пользователем
                    console.log('Поток был отменен');
                } else {
                    // Обрабатываем другие ошибки
                    console.error('Ошибка в потоке:', error);
                    responseDiv.innerHTML = '';
                    
                    const errorDiv = document.createElement('div');
                    errorDiv.className = 'error';
                    errorDiv.textContent = `Ошибка: ${error.message}`;
                    responseDiv.appendChild(errorDiv);
                    
                    statusDiv.className = 'status-indicator status-error';
                    statusDiv.textContent = 'Произошла ошибка при выполнении запроса';
                    statusDiv.style.display = 'block';
                }
                
                // Возвращаем элементы в исходное состояние
                cleanupAfterStreaming();
            });
        }
        
        // Функция завершения потоковой обработки
        function completeStreaming() {
            const responseDiv = document.getElementById('response');
            const statusDiv = document.getElementById('status');
            
            // Форматирование полученного ответа
            const rawResponse = responseDiv.innerHTML;
            responseDiv.innerHTML = marked.parse(rawResponse);
            
            // Добавляем класс для анимации
            responseDiv.classList.add('fade-in');
            
            // Подсвечиваем код
            responseDiv.querySelectorAll('pre code').forEach((block) => {
                hljs.highlightElement(block);
            });
            
            // Обрабатываем LaTeX
            if (window.MathJax) {
                MathJax.typesetPromise([responseDiv]).catch((err) => console.log('MathJax error:', err));
            }
            
            // Показываем статус успеха
            statusDiv.className = 'status-indicator status-success';
            statusDiv.textContent = 'Ответ успешно получен';
            statusDiv.style.display = 'block';
            
            // Очищаем состояние потока
            cleanupAfterStreaming();
            
            // Добавляем время ответа
            if (startTime) {
                const elapsed = Math.floor((Date.now() - startTime) / 1000);
                const minutes = Math.floor(elapsed / 60);
                const seconds = elapsed % 60;
                const timeStr = minutes > 0 ? 
                    `${minutes}м ${seconds}с` : 
                    `${seconds}с`;
                
                const timeDiv = document.createElement('div');
                timeDiv.className = 'response-time';
                timeDiv.textContent = `Время ответа: ${timeStr}`;
                responseDiv.appendChild(timeDiv);
            }
            
            // Прокручиваем к ответу
            responseDiv.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
            
            // Обновляем страницу для отображения обновленной истории
            setTimeout(() => {
                window.location.reload();
            }, 1000);
        }
        
        // Очистка после стриминга
        function cleanupAfterStreaming() {
            const submitBtn = document.getElementById('submit-btn');
            const messageInput = document.getElementById('message-input');
            
            // Сбрасываем контроллер
            streamController = null;
            
            // Снимаем метку стриминга
            document.body.classList.remove('streaming');
            
            // Включаем элементы формы
            submitBtn.disabled = false;
            messageInput.disabled = false;
            
            // Очищаем поле ввода
            messageInput.value = '';
            
            // Останавливаем таймер
            if (timerInterval) {
                clearInterval(timerInterval);
                timerInterval = null;
            }
            
            startTime = null;
        }
        
        // Обработка обычного запроса
        function handleRegularRequest(message) {
            const formData = new FormData();
            formData.append('message', message);
            
            fetch('/chat', {
                method: 'POST',
                body: formData
            })
            .then(response => {
                if (!response.ok) {
                    return response.text().then(text => {
                        throw new Error(text || `Ошибка сервера: ${response.status}`);
                    });
                }
                return response.text();
            })
            .then(data => {
                const responseDiv = document.getElementById('response');
                const statusDiv = document.getElementById('status');
                
                // Преобразуем ответ в Markdown
                const decodedResponse = new DOMParser().parseFromString(data, 'text/html').documentElement.textContent;
                responseDiv.innerHTML = marked.parse(decodedResponse);
                responseDiv.classList.add('fade-in');
                
                // Добавляем время ответа
                const timeDiv = document.createElement('div');
                timeDiv.className = 'response-time';
                const elapsed = Math.floor((Date.now() - startTime) / 1000);
                const minutes = Math.floor(elapsed / 60);
                const seconds = elapsed % 60;
                const timeStr = minutes > 0 ? 
                    `${minutes}м ${seconds}с` : 
                    `${seconds}с`;
                timeDiv.textContent = `Время ответа: ${timeStr}`;
                responseDiv.appendChild(timeDiv);
                
                // Подсвечиваем код
                responseDiv.querySelectorAll('pre code').forEach((block) => {
                    hljs.highlightElement(block);
                });
                
                // Обрабатываем LaTeX
                if (window.MathJax) {
                    MathJax.typesetPromise([responseDiv]).catch((err) => console.log('MathJax error:', err));
                }
                
                statusDiv.className = 'status-indicator status-success';
                statusDiv.textContent = 'Ответ успешно получен';
                statusDiv.style.display = 'block';
                
                // Включаем форму и очищаем поле ввода
                document.getElementById('submit-btn').disabled = false;
                const messageInput = document.getElementById('message-input');
                messageInput.disabled = false;
                messageInput.value = '';
                
                // Останавливаем таймер
                if (timerInterval) {
                    clearInterval(timerInterval);
                    timerInterval = null;
                }
                
                startTime = null;
                
                // Прокрутка к ответу
                responseDiv.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                
                // Обновляем страницу для отображения обновленной истории
                setTimeout(() => {
                    window.location.reload();
                }, 1000);
            })
            .catch(error => {
                const responseDiv = document.getElementById('response');
                const statusDiv = document.getElementById('status');
                
                const errorDiv = document.createElement('div');
                errorDiv.className = 'error';
                errorDiv.textContent = error.message;
                responseDiv.innerHTML = '';
                responseDiv.appendChild(errorDiv);
                
                statusDiv.className = 'status-indicator status-error';
                statusDiv.textContent = 'Произошла ошибка при выполнении запроса';
                statusDiv.style.display = 'block';
                
                // Включаем форму
                document.getElementById('submit-btn').disabled = false;
                const messageInput = document.getElementById('message-input');
                messageInput.disabled = false;
                
                // Останавливаем таймер
                if (timerInterval) {
                    clearInterval(timerInterval);
                    timerInterval = null;
                }
                
                startTime = null;
            });
        }
    </script>
</body>
</html> 